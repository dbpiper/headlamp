name: npm

on:
  workflow_dispatch: {}
  push:
    tags:
      - "v*"

jobs:
  build-binaries:
    name: build (${{ matrix.target_label }})
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_label: darwin-arm64
            runs_on: macos-14
            cargo_target: aarch64-apple-darwin
            binary_name: headlamp
          - target_label: darwin-x64
            runs_on: macos-13
            cargo_target: x86_64-apple-darwin
            binary_name: headlamp
          - target_label: linux-x64-gnu
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-arm64-gnu
            runs_on: ubuntu-latest
            cargo_target: aarch64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-x64-musl
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-musl
            binary_name: headlamp
          - target_label: linux-arm64-musl
            runs_on: ubuntu-latest
            cargo_target: aarch64-unknown-linux-musl
            binary_name: headlamp
          - target_label: win32-x64
            runs_on: windows-latest
            cargo_target: x86_64-pc-windows-msvc
            binary_name: headlamp.exe

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.cargo_target }}

      - uses: Swatinem/rust-cache@v2

      - name: Install cross (linux only)
        if: runner.os == 'Linux'
        run: cargo install cross --locked

      - name: Build (linux via cross)
        if: runner.os == 'Linux'
        run: cross build -p headlamp --release --target ${{ matrix.cargo_target }}

      - name: Build (non-linux)
        if: runner.os != 'Linux'
        run: cargo build -p headlamp --release --target ${{ matrix.cargo_target }}

      - name: Collect binary
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/${{ matrix.target_label }}
          cp target/${{ matrix.cargo_target }}/release/${{ matrix.binary_name }} dist/${{ matrix.target_label }}/

      - uses: actions/upload-artifact@v4
        with:
          name: headlamp-bin-${{ matrix.target_label }}
          path: dist/${{ matrix.target_label }}/

  assemble-npm:
    name: assemble npm package
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: headlamp/npm/headlamp/package.json

      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Stage binaries into npm package
        shell: bash
        run: |
          set -euo pipefail
          pkg="headlamp/npm/headlamp"
          rm -rf "$pkg/bin"
          mkdir -p "$pkg/bin"

          copy_one() {
            local label="$1"
            local file="$2"
            mkdir -p "$pkg/bin/$label"
            cp "$file" "$pkg/bin/$label/"
            chmod 755 "$pkg/bin/$label/"* || true
          }

          copy_one "darwin-arm64"   "artifacts/headlamp-bin-darwin-arm64/headlamp"
          copy_one "darwin-x64"     "artifacts/headlamp-bin-darwin-x64/headlamp"
          copy_one "linux-x64-gnu"  "artifacts/headlamp-bin-linux-x64-gnu/headlamp"
          copy_one "linux-arm64-gnu" "artifacts/headlamp-bin-linux-arm64-gnu/headlamp"
          copy_one "linux-x64-musl" "artifacts/headlamp-bin-linux-x64-musl/headlamp"
          copy_one "linux-arm64-musl" "artifacts/headlamp-bin-linux-arm64-musl/headlamp"
          copy_one "win32-x64"      "artifacts/headlamp-bin-win32-x64/headlamp.exe"

      - name: npm pack
        working-directory: headlamp/npm/headlamp
        run: npm pack

      - uses: actions/upload-artifact@v4
        with:
          name: headlamp-npm-tarball
          path: headlamp/npm/headlamp/headlamp-*.tgz


