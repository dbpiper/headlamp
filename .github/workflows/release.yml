name: release

on:
  workflow_dispatch: {}
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify:
    name: verify (fmt + clippy + run)
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0
      RUSTC_WRAPPER: sccache
      RUSTFLAGS: -C link-arg=-fuse-ld=mold
      SCCACHE_GHA_CACHE_TO: sccache-${{ github.ref_name }}
      SCCACHE_GHA_CACHE_FROM: sccache-${{ github.ref_name }},sccache-main
      HEADLAMP_PARITY_DUMP_ROOT: ${{ github.workspace }}/ci-dumps
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Parity + runner tests require JS + Python deps. These are intentionally NOT committed.
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: headlamp_tests/tests/js_deps/package-lock.json

      - name: Install JS deps for parity fixtures (jest)
        working-directory: headlamp_tests/tests/js_deps
        run: npm ci

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: headlamp_tests/tests/py_deps/requirements.txt

      - name: Install Python deps for parity fixtures (pytest)
        run: python3 -m pip install -r headlamp_tests/tests/py_deps/requirements.txt

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install system packages (sccache + mold)
        run: |
          sudo apt-get update
          sudo apt-get install -y sccache mold

      - name: Configure sccache (GHA backend env)
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_RESULTS_URL', process.env.ACTIONS_RESULTS_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Cache cargo + sccache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cache/sccache
          key: ${{ runner.os }}-cargo-verify-${{ hashFiles('**/Cargo.lock') }}

      - name: cargo fmt
        run: cargo fmt --all --check

      - name: cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: run headlamp (changed=lastRelease)
        run: cargo run -p headlamp --locked -- --runner=cargo-nextest --changed=lastRelease

      - name: Parity diagnostics index (on failure)
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          echo "headlamp: parity diagnostics root: ${HEADLAMP_PARITY_DUMP_ROOT}"
          if [ -d "${HEADLAMP_PARITY_DUMP_ROOT}" ]; then
            echo "headlamp: diagnostics files (first 200):"
            find "${HEADLAMP_PARITY_DUMP_ROOT}" -type f | sort | head -200
          else
            echo "headlamp: no diagnostics directory found"
          fi

      - name: Upload parity diagnostics (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: headlamp-parity-diagnostics-${{ github.run_id }}-${{ github.run_attempt }}
          path: ci-dumps
          if-no-files-found: ignore

      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  build-binaries:
    name: build (${{ matrix.target_label }})
    needs: verify
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_label: darwin-arm64
            runs_on: macos-latest
            cargo_target: aarch64-apple-darwin
            binary_name: headlamp
          - target_label: darwin-x64
            runs_on: macos-latest
            cargo_target: x86_64-apple-darwin
            binary_name: headlamp
          - target_label: linux-x64-gnu
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-arm64-gnu
            runs_on: ubuntu-latest
            cargo_target: aarch64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-x64-musl
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-musl
            binary_name: headlamp
          - target_label: linux-arm64-musl
            runs_on: ubuntu-latest
            cargo_target: aarch64-unknown-linux-musl
            binary_name: headlamp
          - target_label: win32-x64
            runs_on: windows-latest
            cargo_target: x86_64-pc-windows-msvc
            binary_name: headlamp.exe

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.cargo_target }}

      - uses: Swatinem/rust-cache@v2

      - name: Install cross (linux only)
        if: runner.os == 'Linux'
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build (linux via cross)
        if: runner.os == 'Linux'
        run: cross build -p headlamp --release --target ${{ matrix.cargo_target }}

      - name: Build (non-linux)
        if: runner.os != 'Linux'
        run: cargo build -p headlamp --release --target ${{ matrix.cargo_target }}

      - name: Package (.gz) (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          src="target/${{ matrix.cargo_target }}/release/${{ matrix.binary_name }}"
          out="dist/${{ matrix.target_label }}-${{ matrix.binary_name }}.gz"
          mkdir -p dist
          python3 - <<'PY'
          import gzip
          import os
          import shutil
          src = os.environ["SRC"]
          out = os.environ["OUT"]
          with open(src, "rb") as input_stream, gzip.open(out, "wb", compresslevel=9) as output_stream:
              shutil.copyfileobj(input_stream, output_stream)
          PY
        env:
          SRC: target/${{ matrix.cargo_target }}/release/${{ matrix.binary_name }}
          OUT: dist/${{ matrix.target_label }}-${{ matrix.binary_name }}.gz

      - name: Package (.gz) (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $src = "target\${{ matrix.cargo_target }}\release\${{ matrix.binary_name }}"
          $out = "dist\${{ matrix.target_label }}-${{ matrix.binary_name }}.gz"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $env:SRC = $src
          $env:OUT = $out
          python -c "import gzip, os, shutil; src=os.environ['SRC']; out=os.environ['OUT']; f_in=open(src,'rb'); f_out=gzip.open(out,'wb',compresslevel=9); shutil.copyfileobj(f_in,f_out); f_out.close(); f_in.close()"

      - uses: actions/upload-artifact@v4
        with:
          name: headlamp-asset-${{ matrix.target_label }}
          path: dist/*.gz

  upload-release-assets:
    name: upload release assets
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload .gz assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/**/*.gz
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: publish (npm)
    needs: upload-release-assets
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Stage platform binaries into npm package
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import gzip
          import os
          import pathlib
          import shutil
          import sys

          repo_root = pathlib.Path(os.environ["GITHUB_WORKSPACE"])
          artifacts_root = repo_root / "artifacts"
          package_root = repo_root / "npm" / "headlamp"
          bin_root = package_root / "bin"

          gz_paths = sorted(artifacts_root.glob("**/*.gz"))
          if not gz_paths:
            sys.stderr.write("publish-npm: no .gz artifacts found\n")
            sys.exit(1)

          for gz_path in gz_paths:
            file_name = gz_path.name
            base = file_name[:-3] if file_name.endswith(".gz") else file_name

            if base.endswith("-headlamp.exe"):
              platform_key = base[: -len("-headlamp.exe")]
              binary_file_name = "headlamp.exe"
            elif base.endswith("-headlamp"):
              platform_key = base[: -len("-headlamp")]
              binary_file_name = "headlamp"
            else:
              sys.stderr.write(f"publish-npm: unrecognized artifact name: {file_name}\n")
              sys.exit(1)

            destination_dir = bin_root / platform_key
            destination_dir.mkdir(parents=True, exist_ok=True)
            destination_path = destination_dir / binary_file_name

            with gzip.open(gz_path, "rb") as gz_stream, open(destination_path, "wb") as out_stream:
              shutil.copyfileobj(gz_stream, out_stream)

            try:
              if binary_file_name != "headlamp.exe":
                destination_path.chmod(0o755)
            except Exception:
              pass

            sys.stdout.write(f"staged: {destination_path}\n")
          PY

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        working-directory: npm/headlamp
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --provenance

  publish-crates:
    name: publish (crates.io)
    needs: upload-release-assets
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p headlamp --locked

  build-pypi-sdist:
    name: build (pypi sdist)
    needs: verify
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build sdist
        working-directory: python/headlamp_pypi
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: headlamp-pypi-sdist
          path: python/headlamp_pypi/dist/*.tar.gz
          if-no-files-found: error

  build-pypi-wheels:
    name: "build (pypi wheels: ${{ matrix.platform_label }})"
    needs: verify
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform_label: macos-x64
            runs_on: macos-latest
          - platform_label: macos-arm64
            runs_on: macos-latest
          - platform_label: windows-x64
            runs_on: windows-latest
          - platform_label: linux-x64-manylinux
            runs_on: ubuntu-latest
          - platform_label: linux-arm64-manylinux
            runs_on: ubuntu-24.04-arm64
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build wheel (macOS/windows)
        if: runner.os != 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          cargo build -p headlamp --release
          mkdir -p python/headlamp_pypi/src/headlamp/bin
          if [ "${RUNNER_OS}" = "Windows" ]; then
            cp -f target/release/headlamp.exe python/headlamp_pypi/src/headlamp/bin/headlamp.exe
          else
            cp -f target/release/headlamp python/headlamp_pypi/src/headlamp/bin/headlamp
            chmod +x python/headlamp_pypi/src/headlamp/bin/headlamp || true
          fi
          python -m pip install --upgrade pip
          python -m pip install build
          (cd python/headlamp_pypi && python -m build --wheel)

      - name: Build wheel (linux manylinux via cibuildwheel)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel
          python -m cibuildwheel python/headlamp_pypi --output-dir python/headlamp_pypi/dist
        env:
          CIBW_BUILD: ${{ matrix.platform_label == 'linux-arm64-manylinux' && 'cp311-manylinux_aarch64' || 'cp311-manylinux_x86_64' }}
          CIBW_SKIP: "*-musllinux*"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          CIBW_ENVIRONMENT: HEADLAMP_GIT_SHA=${{ github.sha }}
          CIBW_BEFORE_BUILD: |
            set -euo pipefail
            PROJECT_DIR="$(pwd)"

            if [ -z "${HEADLAMP_GIT_SHA:-}" ]; then
              echo "headlamp: HEADLAMP_GIT_SHA is required"
              exit 1
            fi

            REPO_WORKDIR="$(mktemp -d)"
            git clone --no-checkout https://github.com/dbpiper/headlamp.git "${REPO_WORKDIR}/headlamp"
            cd "${REPO_WORKDIR}/headlamp"
            git fetch --depth 1 origin "${HEADLAMP_GIT_SHA}"
            git checkout --detach FETCH_HEAD

            curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
            . "${HOME}/.cargo/env"
            cargo build -p headlamp --release
            mkdir -p "${PROJECT_DIR}/src/headlamp/bin"
            cp -f "target/release/headlamp" "${PROJECT_DIR}/src/headlamp/bin/headlamp"
            chmod +x "${PROJECT_DIR}/src/headlamp/bin/headlamp" || true

      - uses: actions/upload-artifact@v4
        with:
          name: headlamp-pypi-wheels-${{ matrix.platform_label }}
          path: python/headlamp_pypi/dist/*.whl
          if-no-files-found: error

  publish-pypi:
    name: publish (pypi)
    needs:
      - build-pypi-wheels
      - build-pypi-sdist
      - upload-release-assets
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts (debug)
        shell: bash
        run: |
          set -euo pipefail
          find artifacts -type f | sort

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: artifacts
