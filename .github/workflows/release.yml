name: release

on:
  workflow_dispatch: {}
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify:
    name: verify (fmt + clippy + run)
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0
      RUSTC_WRAPPER: sccache
      RUSTFLAGS: -C link-arg=-fuse-ld=mold
      SCCACHE_GHA_CACHE_TO: sccache-${{ github.ref_name }}
      SCCACHE_GHA_CACHE_FROM: sccache-${{ github.ref_name }},sccache-main
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install system packages (sccache + mold)
        run: |
          sudo apt-get update
          sudo apt-get install -y sccache mold

      - name: Configure sccache (GHA backend env)
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_RESULTS_URL', process.env.ACTIONS_RESULTS_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Cache cargo + sccache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cache/sccache
          key: ${{ runner.os }}-cargo-verify-${{ hashFiles('**/Cargo.lock') }}

      - name: cargo fmt
        run: cargo fmt --all --check

      - name: cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: run headlamp (changed=lastRelease)
        run: cargo run -p headlamp --locked -- --runner=cargo-nextest --changed=lastRelease

      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  build-binaries:
    name: build (${{ matrix.target_label }})
    needs: verify
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_label: darwin-arm64
            runs_on: macos-latest
            cargo_target: aarch64-apple-darwin
            binary_name: headlamp
          - target_label: darwin-x64
            runs_on: macos-latest
            cargo_target: x86_64-apple-darwin
            binary_name: headlamp
          - target_label: linux-x64-gnu
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-arm64-gnu
            runs_on: ubuntu-latest
            cargo_target: aarch64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-x64-musl
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-musl
            binary_name: headlamp
          - target_label: linux-arm64-musl
            runs_on: ubuntu-latest
            cargo_target: aarch64-unknown-linux-musl
            binary_name: headlamp
          - target_label: win32-x64
            runs_on: windows-latest
            cargo_target: x86_64-pc-windows-msvc
            binary_name: headlamp.exe

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.cargo_target }}

      - uses: Swatinem/rust-cache@v2

      - name: Install cross (linux only)
        if: runner.os == 'Linux'
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build (linux via cross)
        if: runner.os == 'Linux'
        run: cross build -p headlamp --release --target ${{ matrix.cargo_target }}

      - name: Build (non-linux)
        if: runner.os != 'Linux'
        run: cargo build -p headlamp --release --target ${{ matrix.cargo_target }}

      - name: Package (.gz) (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          src="target/${{ matrix.cargo_target }}/release/${{ matrix.binary_name }}"
          out="dist/${{ matrix.target_label }}-${{ matrix.binary_name }}.gz"
          mkdir -p dist
          python3 - <<'PY'
          import gzip
          import os
          import shutil
          src = os.environ["SRC"]
          out = os.environ["OUT"]
          with open(src, "rb") as input_stream, gzip.open(out, "wb", compresslevel=9) as output_stream:
              shutil.copyfileobj(input_stream, output_stream)
          PY
        env:
          SRC: target/${{ matrix.cargo_target }}/release/${{ matrix.binary_name }}
          OUT: dist/${{ matrix.target_label }}-${{ matrix.binary_name }}.gz

      - name: Package (.gz) (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $src = "target\${{ matrix.cargo_target }}\release\${{ matrix.binary_name }}"
          $out = "dist\${{ matrix.target_label }}-${{ matrix.binary_name }}.gz"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $env:SRC = $src
          $env:OUT = $out
          python -c "import gzip, os, shutil; src=os.environ['SRC']; out=os.environ['OUT']; f_in=open(src,'rb'); f_out=gzip.open(out,'wb',compresslevel=9); shutil.copyfileobj(f_in,f_out); f_out.close(); f_in.close()"

      - uses: actions/upload-artifact@v4
        with:
          name: headlamp-asset-${{ matrix.target_label }}
          path: dist/*.gz

  upload-release-assets:
    name: upload release assets
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload .gz assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/**/*.gz
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: publish (npm)
    needs: upload-release-assets
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Stage platform binaries into npm package
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import gzip
          import os
          import pathlib
          import shutil
          import sys

          repo_root = pathlib.Path(os.environ["GITHUB_WORKSPACE"])
          artifacts_root = repo_root / "artifacts"
          package_root = repo_root / "npm" / "headlamp"
          bin_root = package_root / "bin"

          gz_paths = sorted(artifacts_root.glob("**/*.gz"))
          if not gz_paths:
            sys.stderr.write("publish-npm: no .gz artifacts found\n")
            sys.exit(1)

          for gz_path in gz_paths:
            file_name = gz_path.name
            base = file_name[:-3] if file_name.endswith(".gz") else file_name

            if base.endswith("-headlamp.exe"):
              platform_key = base[: -len("-headlamp.exe")]
              binary_file_name = "headlamp.exe"
            elif base.endswith("-headlamp"):
              platform_key = base[: -len("-headlamp")]
              binary_file_name = "headlamp"
            else:
              sys.stderr.write(f"publish-npm: unrecognized artifact name: {file_name}\n")
              sys.exit(1)

            destination_dir = bin_root / platform_key
            destination_dir.mkdir(parents=True, exist_ok=True)
            destination_path = destination_dir / binary_file_name

            with gzip.open(gz_path, "rb") as gz_stream, open(destination_path, "wb") as out_stream:
              shutil.copyfileobj(gz_stream, out_stream)

            try:
              if binary_file_name != "headlamp.exe":
                destination_path.chmod(0o755)
            except Exception:
              pass

            sys.stdout.write(f"staged: {destination_path}\n")
          PY

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        working-directory: npm/headlamp
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --provenance

  publish-crates:
    name: publish (crates.io)
    needs: upload-release-assets
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p headlamp --locked
