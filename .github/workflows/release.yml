name: release

on:
  workflow_dispatch: {}
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  verify:
    name: verify (fmt + clippy + run)
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0
      RUSTC_WRAPPER: sccache
      RUSTFLAGS: -C link-arg=-fuse-ld=mold
      SCCACHE_GHA_CACHE_TO: sccache-${{ github.ref_name }}
      SCCACHE_GHA_CACHE_FROM: sccache-${{ github.ref_name }},sccache-main
      HEADLAMP_PARITY_DUMP_ROOT: ${{ github.workspace }}/ci-dumps
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Parity + runner tests require JS + Python deps. These are intentionally NOT committed.
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: headlamp_tests/tests/js_deps/package-lock.json

      - name: Install JS deps for parity fixtures (jest)
        working-directory: headlamp_tests/tests/js_deps
        run: npm ci

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: headlamp_tests/tests/py_deps/requirements.txt

      - name: Install Python deps for parity fixtures (pytest)
        run: python3 -m pip install -r headlamp_tests/tests/py_deps/requirements.txt

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Install system packages (sccache + mold)
        run: |
          sudo apt-get update
          sudo apt-get install -y sccache mold

      - name: Configure sccache (GHA backend env)
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_RESULTS_URL', process.env.ACTIONS_RESULTS_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Cache cargo + sccache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cache/sccache
          key: ${{ runner.os }}-cargo-verify-${{ hashFiles('**/Cargo.lock') }}

      - name: cargo fmt
        run: cargo fmt --all --check

      - name: cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: run headlamp (changed=lastRelease)
        run: cargo run -p headlamp --locked -- --runner=cargo-nextest --changed=lastRelease

      - name: Parity diagnostics index (on failure)
        if: failure()
        shell: bash
        run: |
          set -euo pipefail
          echo "headlamp: parity diagnostics root: ${HEADLAMP_PARITY_DUMP_ROOT}"
          if [ -d "${HEADLAMP_PARITY_DUMP_ROOT}" ]; then
            echo "headlamp: diagnostics files (first 200):"
            find "${HEADLAMP_PARITY_DUMP_ROOT}" -type f | sort | head -200
          else
            echo "headlamp: no diagnostics directory found"
          fi

      - name: Upload parity diagnostics (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: headlamp-parity-diagnostics-${{ github.run_id }}-${{ github.run_attempt }}
          path: ci-dumps
          if-no-files-found: ignore

      - name: sccache stats
        if: always()
        run: sccache --show-stats || true

  build-binaries:
    name: build (${{ matrix.target_label }})
    needs: verify
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_label: darwin-arm64
            runs_on: macos-latest
            cargo_target: aarch64-apple-darwin
            binary_name: headlamp
          - target_label: darwin-x64
            runs_on: macos-latest
            cargo_target: x86_64-apple-darwin
            binary_name: headlamp
          - target_label: linux-x64-gnu
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-arm64-gnu
            runs_on: ubuntu-24.04-arm
            cargo_target: aarch64-unknown-linux-gnu
            binary_name: headlamp
          - target_label: linux-x64-musl
            runs_on: ubuntu-latest
            cargo_target: x86_64-unknown-linux-musl
            binary_name: headlamp
          - target_label: linux-arm64-musl
            runs_on: ubuntu-24.04-arm
            cargo_target: aarch64-unknown-linux-musl
            binary_name: headlamp
          - target_label: win32-x64
            runs_on: windows-latest
            cargo_target: x86_64-pc-windows-msvc
            binary_name: headlamp.exe

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.cargo_target }}

      - uses: Swatinem/rust-cache@v2

      - name: Build (linux manylinux) (gnu targets)
        if: runner.os == 'Linux' && (matrix.target_label == 'linux-x64-gnu' || matrix.target_label == 'linux-arm64-gnu')
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ matrix.target_label }}" = "linux-x64-gnu" ]; then
            image="quay.io/pypa/manylinux_2_28_x86_64:latest"
          else
            image="quay.io/pypa/manylinux_2_28_aarch64:latest"
          fi
          docker run --rm -v "$PWD":/work -w /work "$image" bash -lc '
            set -euo pipefail
            curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
            . "${HOME}/.cargo/env"
            cargo build -p headlamp --release
          '

      - name: Build (linux musllinux) (musl targets)
        if: runner.os == 'Linux' && (matrix.target_label == 'linux-x64-musl' || matrix.target_label == 'linux-arm64-musl')
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ matrix.target_label }}" = "linux-x64-musl" ]; then
            image="quay.io/pypa/musllinux_1_2_x86_64:latest"
          else
            image="quay.io/pypa/musllinux_1_2_aarch64:latest"
          fi
          docker run --rm -v "$PWD":/work -w /work "$image" bash -lc '
            set -euo pipefail
            # git2/libgit2-sys needs zlib; for musl we link statically so we need libz.a.
            if command -v apk >/dev/null 2>&1; then
              apk add --no-cache zlib-dev zlib-static
            fi
            curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
            . "${HOME}/.cargo/env"
            rustup target add '"${{ matrix.cargo_target }}"'
            cargo build -p headlamp --release --target '"${{ matrix.cargo_target }}"'
          '

      - name: Build (non-linux)
        if: runner.os != 'Linux'
        run: cargo build -p headlamp --release --target ${{ matrix.cargo_target }}

      - uses: actions/setup-python@v5
        if: startsWith(github.ref, 'refs/tags/v') && (matrix.target_label == 'darwin-x64' || matrix.target_label == 'darwin-arm64' || matrix.target_label == 'win32-x64' || matrix.target_label == 'linux-x64-gnu' || matrix.target_label == 'linux-arm64-gnu' || matrix.target_label == 'linux-x64-musl' || matrix.target_label == 'linux-arm64-musl')
        with:
          python-version: "3.11"

      - name: Build PyPI wheel (macOS)
        if: startsWith(github.ref, 'refs/tags/v') && (matrix.target_label == 'darwin-x64' || matrix.target_label == 'darwin-arm64')
        shell: bash
        run: |
          set -euo pipefail
          rm -rf python/headlamp_pypi/dist
          mkdir -p python/headlamp_pypi/src/headlamp/bin
          cp -f "target/${{ matrix.cargo_target }}/release/headlamp" python/headlamp_pypi/src/headlamp/bin/headlamp
          chmod +x python/headlamp_pypi/src/headlamp/bin/headlamp || true
          test -s python/headlamp_pypi/src/headlamp/bin/headlamp
          file python/headlamp_pypi/src/headlamp/bin/headlamp | grep -qi 'Mach-O'
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel
          python -m cibuildwheel python/headlamp_pypi --output-dir python/headlamp_pypi/dist
        env:
          CIBW_BUILD: "cp311-*"
          CIBW_ARCHS_MACOS: ${{ matrix.target_label == 'darwin-x64' && 'x86_64' || 'arm64' }}
          CIBW_ENVIRONMENT_MACOS: ${{ matrix.target_label == 'darwin-x64' && 'MACOSX_DEPLOYMENT_TARGET=10.12' || 'MACOSX_DEPLOYMENT_TARGET=11.0' }}

      - name: Upload PyPI wheel artifact (macOS)
        if: startsWith(github.ref, 'refs/tags/v') && (matrix.target_label == 'darwin-x64' || matrix.target_label == 'darwin-arm64')
        uses: actions/upload-artifact@v4
        with:
          name: headlamp-pypi-wheels-${{ matrix.target_label == 'darwin-x64' && 'macos-x64' || 'macos-arm64' }}
          path: python/headlamp_pypi/dist/*.whl
          if-no-files-found: error

      - name: Build PyPI wheel (Windows)
        if: startsWith(github.ref, 'refs/tags/v') && matrix.target_label == 'win32-x64'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force python\headlamp_pypi\dist -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path python\headlamp_pypi\src\headlamp\bin | Out-Null
          $binaryPath = "python\headlamp_pypi\src\headlamp\bin\headlamp.exe"
          Copy-Item -Force "target\${{ matrix.cargo_target }}\release\headlamp.exe" $binaryPath
          if (-not (Test-Path $binaryPath)) { throw "missing expected binary: $binaryPath" }
          if ((Get-Item $binaryPath).Length -le 0) { throw "binary is empty: $binaryPath" }
          $bytes = [System.IO.File]::ReadAllBytes($binaryPath)
          if ($bytes.Length -lt 2 -or $bytes[0] -ne 0x4D -or $bytes[1] -ne 0x5A) { throw "binary is not a PE (missing MZ header): $binaryPath" }
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel
          python -m cibuildwheel python/headlamp_pypi --output-dir python/headlamp_pypi/dist
        env:
          CIBW_BUILD: "cp311-win_amd64"
          CIBW_ARCHS_WINDOWS: "AMD64"

      - name: Upload PyPI wheel artifact (Windows)
        if: startsWith(github.ref, 'refs/tags/v') && matrix.target_label == 'win32-x64'
        uses: actions/upload-artifact@v4
        with:
          name: headlamp-pypi-wheels-windows-x64
          path: python/headlamp_pypi/dist/*.whl
          if-no-files-found: error

      - name: Build PyPI wheel (linux manylinux)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Linux' && (matrix.target_label == 'linux-x64-gnu' || matrix.target_label == 'linux-arm64-gnu')
        shell: bash
        run: |
          set -euo pipefail
          rm -rf python/headlamp_pypi/dist
          mkdir -p python/headlamp_pypi/dist

          # Build wheels from a temp copy outside the git repo so cibuildwheel definitely
          # includes the injected binary when copying sources into the manylinux container.
          tmp_dir="$(mktemp -d)"
          pkg_dir="${tmp_dir}/headlamp_pypi"
          mkdir -p "${pkg_dir}"
          rsync -a --delete --exclude 'build' --exclude 'dist' --exclude '*.egg-info' python/headlamp_pypi/ "${pkg_dir}/"
          mkdir -p "${pkg_dir}/src/headlamp/bin"
          cp -f target/release/headlamp "${pkg_dir}/src/headlamp/bin/headlamp"
          chmod +x "${pkg_dir}/src/headlamp/bin/headlamp" || true

          python -m pip install --upgrade pip
          python -m pip install cibuildwheel
          pushd "${pkg_dir}"
          python -m cibuildwheel . --output-dir "${GITHUB_WORKSPACE}/python/headlamp_pypi/dist"
          popd
        env:
          CIBW_BUILD: ${{ matrix.target_label == 'linux-arm64-gnu' && 'cp311-manylinux_aarch64' || 'cp311-manylinux_x86_64' }}
          CIBW_SKIP: "*-musllinux*"
          CIBW_BUILD_FRONTEND: build
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          CIBW_BEFORE_BUILD: |
            set -euo pipefail
            echo "headlamp: cibw before_build diagnostics"
            pwd
            ls -lah src/headlamp/bin || true
            ls -lah src/headlamp/bin/headlamp || true
            test -s "src/headlamp/bin/headlamp"
            chmod +x "src/headlamp/bin/headlamp" || true
            if command -v file >/dev/null 2>&1; then
              file "src/headlamp/bin/headlamp" || true
            fi
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "src/headlamp/bin/headlamp" || true
            fi
            python - <<'PY'
            from __future__ import annotations

            import pathlib

            binary_path = pathlib.Path("src/headlamp/bin/headlamp")
            size_bytes = binary_path.stat().st_size
            print(f"headlamp: size={size_bytes}")
            if size_bytes < 1_000_000:
              raise SystemExit("headlamp: binary unexpectedly small")
            magic = binary_path.read_bytes()[:4]
            print(f"headlamp: magic={magic.hex()}")
            if magic != b"\x7fELF":
              raise SystemExit("headlamp: expected ELF magic bytes")
            PY

      - name: Upload PyPI wheel artifact (linux manylinux)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Linux' && (matrix.target_label == 'linux-x64-gnu' || matrix.target_label == 'linux-arm64-gnu')
        uses: actions/upload-artifact@v4
        with:
          name: headlamp-pypi-wheels-${{ matrix.target_label == 'linux-arm64-gnu' && 'linux-arm64-manylinux' || 'linux-x64-manylinux' }}
          path: python/headlamp_pypi/dist/*.whl
          if-no-files-found: error

      - name: Build PyPI wheel (linux musllinux)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Linux' && (matrix.target_label == 'linux-x64-musl' || matrix.target_label == 'linux-arm64-musl')
        shell: bash
        run: |
          set -euo pipefail
          rm -rf python/headlamp_pypi/dist
          mkdir -p python/headlamp_pypi/dist

          tmp_dir="$(mktemp -d)"
          pkg_dir="${tmp_dir}/headlamp_pypi"
          mkdir -p "${pkg_dir}"
          rsync -a --delete --exclude 'build' --exclude 'dist' --exclude '*.egg-info' python/headlamp_pypi/ "${pkg_dir}/"
          mkdir -p "${pkg_dir}/src/headlamp/bin"
          cp -f "target/${{ matrix.cargo_target }}/release/headlamp" "${pkg_dir}/src/headlamp/bin/headlamp"
          chmod +x "${pkg_dir}/src/headlamp/bin/headlamp" || true

          python -m pip install --upgrade pip
          python -m pip install cibuildwheel
          pushd "${pkg_dir}"
          python -m cibuildwheel . --output-dir "${GITHUB_WORKSPACE}/python/headlamp_pypi/dist"
          popd
        env:
          CIBW_BUILD: ${{ matrix.target_label == 'linux-arm64-musl' && 'cp311-musllinux_aarch64' || 'cp311-musllinux_x86_64' }}
          CIBW_SKIP: "*-manylinux*"
          CIBW_BUILD_FRONTEND: build
          CIBW_MUSLLINUX_X86_64_IMAGE: musllinux_1_2
          CIBW_MUSLLINUX_AARCH64_IMAGE: musllinux_1_2
          CIBW_BEFORE_BUILD: |
            set -euo pipefail
            test -s "src/headlamp/bin/headlamp"
            chmod +x "src/headlamp/bin/headlamp" || true
            python - <<'PY'
            from __future__ import annotations

            import pathlib

            binary_path = pathlib.Path("src/headlamp/bin/headlamp")
            size_bytes = binary_path.stat().st_size
            print(f"headlamp: size={size_bytes}")
            if size_bytes < 1_000_000:
              raise SystemExit("headlamp: binary unexpectedly small")
            magic = binary_path.read_bytes()[:4]
            print(f"headlamp: magic={magic.hex()}")
            if magic != b"\x7fELF":
              raise SystemExit("headlamp: expected ELF magic bytes")
            PY

      - name: Upload PyPI wheel artifact (linux musllinux)
        if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Linux' && (matrix.target_label == 'linux-x64-musl' || matrix.target_label == 'linux-arm64-musl')
        uses: actions/upload-artifact@v4
        with:
          name: headlamp-pypi-wheels-${{ matrix.target_label == 'linux-arm64-musl' && 'linux-arm64-musllinux' || 'linux-x64-musllinux' }}
          path: python/headlamp_pypi/dist/*.whl
          if-no-files-found: error

      - name: Package (.gz) (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ matrix.target_label }}" = "linux-x64-gnu" ] || [ "${{ matrix.target_label }}" = "linux-arm64-gnu" ]; then
            src="target/release/${{ matrix.binary_name }}"
          else
            src="target/${{ matrix.cargo_target }}/release/${{ matrix.binary_name }}"
          fi
          out="dist/${{ matrix.target_label }}-${{ matrix.binary_name }}.gz"
          mkdir -p dist
          python3 - <<'PY'
          import gzip
          import os
          import shutil
          src = os.environ["SRC"]
          out = os.environ["OUT"]
          with open(src, "rb") as input_stream, gzip.open(out, "wb", compresslevel=9) as output_stream:
              shutil.copyfileobj(input_stream, output_stream)
          PY
        env:
          SRC: ${{ (matrix.target_label == 'linux-x64-gnu' || matrix.target_label == 'linux-arm64-gnu') && format('target/release/{0}', matrix.binary_name) || format('target/{0}/release/{1}', matrix.cargo_target, matrix.binary_name) }}
          OUT: dist/${{ matrix.target_label }}-${{ matrix.binary_name }}.gz

      - name: Package (.gz) (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $src = "target\${{ matrix.cargo_target }}\release\${{ matrix.binary_name }}"
          $out = "dist\${{ matrix.target_label }}-${{ matrix.binary_name }}.gz"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $env:SRC = $src
          $env:OUT = $out
          python -c "import gzip, os, shutil; src=os.environ['SRC']; out=os.environ['OUT']; f_in=open(src,'rb'); f_out=gzip.open(out,'wb',compresslevel=9); shutil.copyfileobj(f_in,f_out); f_out.close(); f_in.close()"

      - uses: actions/upload-artifact@v4
        with:
          name: headlamp-asset-${{ matrix.target_label }}
          path: dist/*.gz

  publish:
    name: publish (release assets + npm + crates + pypi)
    needs: build-binaries
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload .gz assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/**/*.gz
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Stage platform binaries into npm package
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import gzip
          import os
          import pathlib
          import shutil
          import sys

          repo_root = pathlib.Path(os.environ["GITHUB_WORKSPACE"])
          artifacts_root = repo_root / "artifacts"
          package_root = repo_root / "npm" / "headlamp"
          bin_root = package_root / "bin"

          gz_paths = sorted(artifacts_root.glob("**/*.gz"))
          if not gz_paths:
            sys.stderr.write("publish: no .gz artifacts found\n")
            sys.exit(1)

          for gz_path in gz_paths:
            file_name = gz_path.name
            base = file_name[:-3] if file_name.endswith(".gz") else file_name

            if base.endswith("-headlamp.exe"):
              platform_key = base[: -len("-headlamp.exe")]
              binary_file_name = "headlamp.exe"
            elif base.endswith("-headlamp"):
              platform_key = base[: -len("-headlamp")]
              binary_file_name = "headlamp"
            else:
              sys.stderr.write(f"publish: unrecognized artifact name: {file_name}\n")
              sys.exit(1)

            destination_dir = bin_root / platform_key
            destination_dir.mkdir(parents=True, exist_ok=True)
            destination_path = destination_dir / binary_file_name

            with gzip.open(gz_path, "rb") as gz_stream, open(destination_path, "wb") as out_stream:
              shutil.copyfileobj(gz_stream, out_stream)

            try:
              if binary_file_name != "headlamp.exe":
                destination_path.chmod(0o755)
            except Exception:
              pass

            sys.stdout.write(f"staged: {destination_path}\n")
          PY

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        working-directory: npm/headlamp
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --provenance

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p headlamp --locked

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build PyPI sdist
        working-directory: python/headlamp_pypi
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build --sdist

      - name: Assemble PyPI dist
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist-pypi
          mkdir -p dist-pypi
          cp -f python/headlamp_pypi/dist/*.tar.gz dist-pypi/
          find artifacts -type f -name '*.whl' -exec cp -f {} dist-pypi/ \;
          ls -lah dist-pypi

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist-pypi
